name: Job – Virality & Monetization

on:
  release:
    types: [published]
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * 1'

jobs:
  craft-marketing-kit:
    name: Generate storytelling + assets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Collect release metadata
        id: release_info
        run: |
          echo "module_name=Job" >> $GITHUB_OUTPUT
          echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
      - name: Build hero changelog
        run: |
          node scripts/marketing/generate-hero-story.mjs \
            --module "Job" \
            --version "${{ steps.release_info.outputs.version }}" \
            --output marketing/hero.md
      - name: Render share cards
        run: |
          npm install --prefer-offline
          npm run build:share-card -- --module "Job" --version "${{ steps.release_info.outputs.version }}"
      - name: Archive marketing kit
        uses: actions/upload-artifact@v4
        with:
          name: "Job-marketing-kit"
          path: |
            marketing/hero.md
            dist/share-cards/

  announce-social:
    name: Amplify on social + community
    needs: craft-marketing-kit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v7
        with:
          name: "Job-marketing-kit"
          path: kit
      - name: Publish on social webhooks
        if: ${{ secrets.MARKETING_WEBHOOK_URL != '' }}
        run: |
          curl -X POST "${{ secrets.MARKETING_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d @kit/hero.md
      - name: Open GitHub Discussion highlight
        uses: actions/github-script@v7
        env:
          MODULE_NAME: "Job"
        with:
          script: |
            github.rest.discussions.createDiscussion({
              repo: context.repo.repo,
              owner: context.repo.owner,
              categoryId: process.env.DISCUSSION_CATEGORY_ID,
              title: `${process.env.MODULE_NAME} ${{ github.ref_name }} – launch highlights`,
              body: require('fs').readFileSync('kit/hero.md', 'utf8'),
            })

  monetize-marketplaces:
    name: Publish to marketplaces & partners
    needs: craft-marketing-kit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build distributable package
        run: |
          composer install --no-dev --prefer-dist
          tar -czf "Job-${{ github.run_number }}.tar.gz" .
      - name: Upload to partner marketplace
        if: ${{ secrets.MARKETPLACE_API_KEY != '' }}
        run: |
          curl -X POST https://api.partner-marketplace.example.com/packages \
            -H "Authorization: Bearer ${{ secrets.MARKETPLACE_API_KEY }}" \
            -F "file=@Job-${{ github.run_number }}.tar.gz"
      - name: Notify sales channel
        if: ${{ secrets.SALESFORCE_WEBHOOK != '' }}
        run: |
          curl -X POST "${{ secrets.SALESFORCE_WEBHOOK }}" \
            -H 'Content-Type: application/json' \
            -d '{"module":"Job","run":${{ github.run_number }},"version":"${{ github.ref_name }}"}'

  recap-newsletter:
    name: Prepare newsletter + sponsorship pitch
    needs: [announce-social, monetize-marketplaces]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v7
        with:
          name: "Job-marketing-kit"
          path: kit
      - name: Compose newsletter draft
        run: |
          python scripts/marketing/render_newsletter.py \
            --module "Job" \
            --hero kit/hero.md \
            --out marketing/newsletter.md
      - name: Email marketing approval
        if: ${{ secrets.MAILCHIMP_API_KEY != '' }}
        run: |
          curl -X POST https://usX.api.mailchimp.com/3.0/campaigns/${{ secrets.MAILCHIMP_CAMPAIGN_ID }}/content \
            -u "anystring:${{ secrets.MAILCHIMP_API_KEY }}" \
            -H 'Content-Type: application/json' \
            -d @marketing/newsletter.md
